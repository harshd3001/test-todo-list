{"processTechs":{"connectors":[{"exitPortType":"NextStep","nodeId":"getDispatcherTechsTaskData"}],"contextChangePermitted":true,"name":"processTechs","description":"processTechs","processRule":"{ if (Array.isArray(contextVar.allTechnicianData) && contextVar.allTechnicianData.length>0) { contextVar.allTechnicianData.forEach(function (obj) { contextVar.dispatcherTechs.push(obj.id); }); contextVar.originalTechnicianArray = JSON.parse(JSON.stringify(contextVar.dispatcherTechs)); } }","id":"appendTechs","nodeType":"PROCESS"},"getOnlineStatusOfTechnicians":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTechniciansAvailabilityList"}],"contextChangePermitted":true,"name":"getOnlineStatusOfTechnicians","description":"getOnlineStatusOfTechnicians","processRule":"{ var localizedKeys = {}; if (typeof contextVar.localizedData !== 'undefined' && contextVar.localizedData !== '') { contextVar.localizedData.forEach(function(element) { localizedKeys[element.listOptionAnswerId] = element.listOptionAnswerAnswerOptionText; }); } var offlineTooltipValue = typeof localizedKeys !== 'undefined' && typeof localizedKeys.wifiStatus !== 'undefined' ? localizedKeys.wifiStatus : 'Offline'; var onlineTooltipValue = typeof localizedKeys !== 'undefined' && typeof localizedKeys.wifiActiveStatus !== 'undefined' ? localizedKeys.wifiActiveStatus : 'Online'; contextVar.technicianData = JSON.parse(JSON.stringify(contextVar.allTechnicianData)); contextVar.technicianData.forEach(function(obj) { if (obj.userLastSeenTime) { var lastSeenTime = new Date(new Date(obj.userLastSeenTime).toUTCString()); var currentTime = new Date((new Date()).toUTCString()); var diff = (currentTime.getTime() - lastSeenTime.getTime()) / 1000; diff = Math.abs(diff / 60); obj.icon = '@iconlib.WifiGreen'; obj.iconTooltip = onlineTooltipValue; if (diff >= 60) { obj.icon = '@iconlib.WifiOff'; obj.iconTooltip = offlineTooltipValue; } } else { obj.icon = '@iconlib.WifiOff'; obj.iconTooltip = offlineTooltipValue; } }); }","id":"getOnlineStatusOfTechnicians","nodeType":"PROCESS"},"processLoggedInUsersDispatcherTechs":{"connectors":[{"exitPortType":"NextStep","nodeId":"isTechnicianPresent"}],"contextChangePermitted":true,"name":"processLoggedInUsersDispatcherTechs","description":"processLoggedInUsersDispatcherTechs","processRule":"{contextVar.dispatcherTechs = []; if (typeof contextVar.dispatcherTechsData !=='undefined' && contextVar.dispatcherTechsData.length > 0) { for (var index in contextVar.dispatcherTechsData[0].dispatcherTechTechs) { contextVar.dispatcherTechs.push(contextVar.dispatcherTechsData[0].dispatcherTechTechs[index].userId); } } if (typeof contextVar.dispatcherTechs !=='undefined' && contextVar.dispatcherTechs.length > 0) { contextVar.filterApplied = true; } else { contextVar.filterApplied = false; } contextVar.dispatcherTechsFilter = '({$id} IN {@loopArray}) AND ({$workforceStatusId}= {@workforceStatusFilter}) AND ({$User.status}!= {@userStatusFilter})';}","nodeType":"PROCESS"},"getDispatcherTechsTaskData":{"eventId":"taskSchedulingCalendarFetchTaskDetailsProcessEvent","connectors":[{"exitPortType":"NextStep","nodeId":"processDispatcherTechsPublishEventData"}],"contextChangePermitted":true,"name":"getDispatcherTechsTaskData","description":"getDispatcherTechsTaskData","inputVarMap":{"statusFilter":"statusFilter","pendingAndCompletedStatus":"pendingAndCompletedStatus","dispatcherTechs":"dispatcherTechs"},"outputVarMap":{"data":"publishEventData"},"nodeType":"PUBLISH","captureOutput":true},"areFilteredUserIdPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"createFilter"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"areFilteredUserIdPresent","description":"areFilteredUserIdPresent","processRule":"typeof contextVar.finalFilteredUserIdList !== 'undefined' && typeof contextVar.finalFilteredUserIdList[contextVar.userList[0]] !== 'undefined' && contextVar.finalFilteredUserIdList[contextVar.userList[0]].length>0","id":"areFilteredUserIdPresent","nodeType":"DECISION"},"areTasksPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"calculateTasksAtRiskAndAlerts"},{"exitPortType":"FalseStep","nodeId":"technicianFilter"}],"name":"areTasksPresent","description":"Use this for decision in workflow","processRule":"(contextVar.schedulingAndDispatchData != '' && contextVar.schedulingAndDispatchData.length > 0)","id":"areTasksPresent","nodeType":"DECISION"},"fetchMoreTechsData":{"models":["workforce","User"],"connectors":[{"exitPortType":"NextStep","nodeId":"appendTechs"}],"columns":{"timezoneOffset":"workforce.timezoneOffset","userLastSeenTime":"User.lastSeenTime","techName":"User.name","id":"workforce.userId","workforceUserId":"workforce.userId","workforceStatusId":"workforce.statusId","workforceCalendarId":"workforce.calendarId"},"distinct":true,"orderBy":"techName ASC","description":"fetchMoreTechsData","inputVarMap":{"customBatchSize":"batchSize","techBatchNumber":"batchNumber","workGroupFilter":"filter","finalFilteredUserIdList":"finalFilteredUserIdList","workforceStatusFilter":"workforceStatusFilter","workforceType":"workforceType","userStatusFilter":"userStatusFilter"},"nodeType":"QUERY","filter":"filter","name":"fetchMoreTechsData","links":{"workforce":"User"},"outputVarMap":{"data":"techDataToAppend"},"batchSize":"batchSize","batchNumber":"batchNumber"},"technicianFilter":{"connectors":[{"exitPortType":"TrueStep","nodeId":"findNumberOfBatchesOfTechnician"},{"exitPortType":"FalseStep","nodeId":"getOnlineStatusOfTechnicians"}],"name":"technicianFilter","description":"technicianFilter","processRule":"contextVar.filterApplied === true","nodeType":"DECISION"},"getTechniciansAvailabilityList":{"connectors":[{"exitPortType":"NextStep","nodeId":"processFinalData"}],"processId":"8EIKAE8E10","name":"getTechniciansAvailabilityList","description":"getTechniciansAvailabilityList","inputVarMap":{"customBatchSize":"batchSize","startDateFilter":"startDateFilter","endDate":"endDate","workflowCall":"workflowCall","endDateFilter":"endDateFilter","schedulingAndDispatchData":"schedulingAndDispatchData","originalTechnicianArray":"dispatcherTechs","allTechnicianData":"techniciansData","startDate":"startDate"},"outputVarMap":{"techniciansData":"techniciansData"},"nodeType":"WORKFLOW"},"appendTechs":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreTechsPresent"}],"contextChangePermitted":true,"name":"appendTechs","description":"appendTechs","processRule":"{if (typeof contextVar.techDataToAppend !=='undefined' && Array.isArray(contextVar.techDataToAppend)) { contextVar.techDataToAppend.forEach(function(obj){contextVar.allTechnicianData.push(obj);}); } contextVar.techBatchNumber = contextVar.techBatchNumber + 1;}","id":"appendTechs","nodeType":"PROCESS"},"workflowContext":{"statusFilter":["workOrderTaskScheduled","workOrderTaskDispatched","workOrderTaskInProgress","workOrderTaskDiscontinued","workOrderTaskIncident","workOrderTaskInTransit","workOrderTaskDelayed"],"workflowCall":"fetchCalendarViewdata","count":0,"workforceStatusFilter":"workforceActive","noOfBatchesOfTech":0,"allTechnicianData":[],"customBatchSize":1000,"newTechBatchNumber":0,"pendingAndCompletedStatus":["workOrderTaskPendingReview","workOrderTaskCompleted"],"dispatcherTechs":[],"workforceType":"webUser","schedulingAndDispatchData":[],"userStatusFilter":"Deactivated"},"processFinalData":{"connectors":[{"exitPortType":"NextStep","nodeId":"end"}],"contextChangePermitted":true,"name":"processFinalData","description":"processFinalData","processRule":"{contextVar.techAndTaskData = { 'taskData': contextVar.schedulingAndDispatchData, 'techData': contextVar.technicianData,'filterApplied':contextVar.filterApplied,'totalTechnicianCount':contextVar.technicianData.length};}","nodeType":"PROCESS"},"technicianProcessData":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTechnicianData"}],"contextChangePermitted":true,"name":"technicianProcessData","description":"technicianProcessData","processRule":"{contextVar.loopArray = [];contextVar.loopArray = contextVar.dispatcherTechs.splice(0,contextVar.customBatchSize);}","nodeType":"PROCESS"},"getLoggedInUser":{"filter":"{$userId}={@userId}","models":["User"],"connectors":[{"exitPortType":"NextStep","nodeId":"processUserId"}],"columns":{"userName":"User.name","userId":"User.id"},"name":"getLoggedInUser","description":"getLoggedInUser","inputVarMap":{"{@userId}":"userId"},"outputVarMap":{"data":"currentUserDetails"},"nodeType":"QUERY"},"end":{"name":"End","description":"end","inputVarMap":{"count":"count","techAndTaskData":"techAndTaskData"},"outputVarMap":{"techAndTaskData":"techAndTaskData"},"id":"end","nodeType":"END"},"getTechnicianData":{"models":["workforce","User"],"connectors":[{"exitPortType":"NextStep","nodeId":"appendTechnicianData"}],"columns":{"timezoneOffset":"workforce.timezoneOffset","userLastSeenTime":"User.lastSeenTime","techName":"User.name","id":"workforce.userId","workforceStatusId":"workforce.statusId","workforceUserId":"workforce.userId","workforceCalendarId":"workforce.calendarId"},"distinct":true,"orderBy":"techName ASC","description":"getTechnicianData","inputVarMap":{"customBatchSize":"batchSize","loopArray":"loopArray","workforceStatusFilter":"workforceStatusFilter","dispatcherTechsFilter":"filter","userStatusFilter":"userStatusFilter"},"nodeType":"QUERY","filter":"filter","name":"getTechnicianData","outputVarMap":{"data":"appendTechnicianData","count":"totalTechnicianCount"},"batchSize":"batchSize","getCount":true},"processDispatcherTechsPublishEventData":{"connectors":[{"exitPortType":"NextStep","nodeId":"areTasksPresent"}],"contextChangePermitted":true,"name":"processDispatcherTechsPublishEventData","description":"processDispatcherTechsPublishEventData","processRule":"{ if (typeof contextVar.publishEventData!=='undefined' && contextVar.publishEventData.length>0) { contextVar.publishEventData.forEach(function (element) { contextVar.schedulingAndDispatchData= contextVar.schedulingAndDispatchData.concat(element.publishEventTaskData); }); } }","id":"processDispatcherTechsPublishEventData","nodeType":"PROCESS"},"getLoggedInUsersDispatcherTechs":{"filter":"{$dispatcherTechLoggedInUserId}={@userId}","models":["dispatcherTech"],"connectors":[{"exitPortType":"NextStep","nodeId":"filterWorkGroupDecision"}],"columns":{"dispatcherTechLoggedInUserId":"dispatcherTech.loggedInUserId","dispatcherTechTechs":"dispatcherTech.techs"},"name":"getLoggedInUsersDispatcherTechs","distinct":true,"description":"getLoggedInUsersDispatcherTechs","inputVarMap":{"{@userId}":"userId"},"outputVarMap":{"data":"dispatcherTechsData","batchSize":"batchSize"},"nodeType":"QUERY"},"areMoreTechsPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"fetchMoreTechsData"},{"exitPortType":"FalseStep","nodeId":"processTechs"}],"name":"areMoreTechsPresent","description":"areMoreTechsPresent","processRule":"contextVar.noOfBatches >= 2 && contextVar.noOfBatches >= contextVar.techBatchNumber","id":"areMoreTechsPresent","nodeType":"DECISION"},"findNumberOfBatches":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreTechsPresent"}],"contextChangePermitted":true,"name":"findNumberOfBatches","description":"findNumberOfBatches","processRule":"contextVar.noOfBatches = Math.ceil(contextVar.allTechnicianCount / contextVar.customBatchSize);contextVar.techBatchNumber = contextVar.techBatchNumber + 1;","nodeType":"PROCESS"},"fetchLocalizedKeys":{"filter":"{$listOptionAnswer.listOptionId}='schedulerComponent' || {$listOptionAnswer.listOptionId}='timeDuration'","models":["listOptionAnswer"],"connectors":[{"exitPortType":"NextStep","nodeId":"getLoggedInUser"}],"columns":{"listOptionAnswerId":"listOptionAnswer.id","listOptionAnswerAnswerOptionText":"listOptionAnswer.answerOptionText"},"name":"fetchLocalizedKeys","description":"fetchLocalizedKeys","outputVarMap":{"data":"localizedData"},"nodeType":"QUERY","translate":true},"start":{"connectors":[{"exitPortType":"NextStep","nodeId":"fetchLocalizedKeys"}],"name":"Start","description":"Start","id":"start","nodeType":"START"},"filterWorkGroupDecision":{"connectors":[{"exitPortType":"TrueStep","nodeId":"processLoggedInUsersDispatcherTechs"},{"exitPortType":"FalseStep","nodeId":"getFilteredUserIdList"}],"name":"filterWorkGroupDecision","description":"filterWorkGroupDecision","processRule":"(contextVar.dispatcherTechsData.length > 0)","nodeType":"DECISION"},"fetchTechnicianData":{"models":["workforce","User"],"connectors":[{"exitPortType":"NextStep","nodeId":"findNumberOfBatches"}],"columns":{"timezoneOffset":"workforce.timezoneOffset","userLastSeenTime":"User.lastSeenTime","techName":"User.name","id":"workforce.userId","workforceUserId":"workforce.userId","workforceStatusId":"workforce.statusId","workforceCalendarId":"workforce.calendarId"},"distinct":true,"orderBy":"techName ASC","description":"fetchTechnicianData","outerJoinOnModel":"workforce","inputVarMap":{"customBatchSize":"batchSize","workGroupFilter":"filter","finalFilteredUserIdList":"finalFilteredUserIdList","workforceStatusFilter":"workforceStatusFilter","workforceType":"workforceType","userStatusFilter":"userStatusFilter"},"nodeType":"QUERY","filter":"filter","name":"fetchTechnicianData","links":{"workforce":"User"},"outputVarMap":{"data":"allTechnicianData","count":"allTechnicianCount","batchNumber":"techBatchNumber"},"batchSize":"batchSize","getCount":true},"getFilteredUserIdList":{"connectors":[{"exitPortType":"NextStep","nodeId":"areFilteredUserIdPresent"}],"processId":"workGroupFilterForTechniciansAndTasksWF","name":"getFilteredUserIdList","description":"getFilteredUserIdList","inputVarMap":{"userList":"userList"},"outputVarMap":{"finalFilteredUserIdList":"finalFilteredUserIdList"},"nodeType":"WORKFLOW"},"createFilter":{"connectors":[{"exitPortType":"NextStep","nodeId":"isTechnicianPresent"}],"contextChangePermitted":true,"name":"createFilter","description":"createFilter","processRule":"{contextVar.finalFilteredUserIdList = contextVar.finalFilteredUserIdList[contextVar.userList[0]];contextVar.workGroupFilter = '({$workforceStatusId} = {@workforceStatusFilter}) AND ({$User.status}!= {@userStatusFilter}) AND ({$workforce.workforceType} IS NULL OR {$workforce.workforceType} != {@workforceType}) AND ({$workforce.userId} IN {@finalFilteredUserIdList})';}","nodeType":"PROCESS"},"appendTechnicianData":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreTechPresent"}],"contextChangePermitted":true,"name":"appendTechnicianData","description":"appendTechnicianData","processRule":"{ if (Array.isArray(contextVar.appendTechnicianData)) { contextVar.appendTechnicianData.forEach(function (obj) { contextVar.allTechnicianData.push(obj); }); } }","id":"appendTechs","nodeType":"PROCESS"},"workflowNodes":["start","fetchLocalizedKeys","getLoggedInUser","getLoggedInUsersDispatcherTechs","processUserId","getFilteredUserIdList","areFilteredUserIdPresent","filterWorkGroupDecision","createFilter","isTechnicianPresent","processLoggedInUsersDispatcherTechs","fetchTechnicianData","findNumberOfBatches","areMoreTechsPresent","fetchMoreTechsData","appendTechs","processTechs","getDispatcherTechsTaskData","processDispatcherTechsPublishEventData","areTasksPresent","calculateTasksAtRiskAndAlerts","technicianFilter","findNumberOfBatchesOfTechnician","areMoreTechPresent","technicianProcessData","getTechnicianData","appendTechnicianData","areTechniciansPresent","getOnlineStatusOfTechnicians","getTechniciansAvailabilityList","processFinalData","end"],"processUserId":{"connectors":[{"exitPortType":"NextStep","nodeId":"getLoggedInUsersDispatcherTechs"}],"contextChangePermitted":true,"name":"processUserId","description":"processUserId","processRule":"if (typeof contextVar.currentUserDetails !=='undefined') { contextVar.userList=[];contextVar.userList.push(contextVar.currentUserDetails[0].userId) };","nodeType":"PROCESS"},"calculateTasksAtRiskAndAlerts":{"connectors":[{"exitPortType":"NextStep","nodeId":"technicianFilter"}],"contextChangePermitted":true,"name":"calculateTasksAtRiskAndAlerts","description":"calculateTasksAtRiskAndAlerts","processRule":"{ var getTimeDifferenceInSeconds = function (date) { var dateToBeCompared = new Date(new Date(date).toUTCString()); var currentTime = new Date((new Date()).toUTCString()); var diff = (currentTime.getTime() - dateToBeCompared.getTime()) / 1000; diff = Math.abs(diff / (60 * 60)); return diff; }; var getFormattedTime = function (hours) { var minutes = Math.floor((hours - Math.floor(hours)) * 60); hours = Math.floor(hours); if (typeof localizedKeys.hoursTD !== 'undefined' && typeof localizedKeys.minutesTD !== 'undefined') { time = (hours < 1) ? minutes + localizedKeys.minutesTD : ((minutes == 0) ? hours + localizedKeys.hoursTD : hours + localizedKeys.hoursTD + ' ' + minutes + localizedKeys.minutesTD); } else { time = (hours < 1) ? minutes + 'm' : ((minutes == 0) ? hours + 'h' : hours + 'h ' + minutes + 'm'); } return time; }; var localizedKeys = {}; if (typeof contextVar.localizedData !== 'undefined' && contextVar.localizedData !== '') { contextVar.localizedData.forEach(function (element) { localizedKeys[element.listOptionAnswerId] = element.listOptionAnswerAnswerOptionText; }); } contextVar.schedulingAndDispatchData.forEach(function (obj) { if (obj.statusId !== 'workOrderTaskCompleted' && obj.workOrderDeadline) { var workOrderDeadlineDiff = getTimeDifferenceInSeconds(obj.workOrderDeadline); if (workOrderDeadlineDiff <= 4) { obj.taskAtRisk = true; if (typeof localizedKeys.slaBreach !== 'undefined') { obj.alert = localizedKeys.slaBreach + ' ' + getFormattedTime(workOrderDeadlineDiff); } else { obj.alert = 'SLA breach in ' + getFormattedTime(workOrderDeadlineDiff); } return; } } if (obj.statusId === 'workOrderTaskScheduled' && obj.workOrderTaskScheduledDate) { var workOrderTaskScheduledDateDiff = getTimeDifferenceInSeconds(obj.workOrderTaskScheduledDate); if (workOrderTaskScheduledDateDiff <= 2) { obj.taskAtRisk = true; if (typeof localizedKeys.toBeDispatched !== 'undefined') { obj.alert = localizedKeys.toBeDispatched + ' ' + getFormattedTime(workOrderTaskScheduledDateDiff); } else { obj.alert = 'To be dispatched in ' + getFormattedTime(workOrderTaskScheduledDateDiff); } } } }); }","id":"calculateTasksAtRiskAndAlerts","nodeType":"PROCESS"},"areMoreTechPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"technicianProcessData"},{"exitPortType":"FalseStep","nodeId":"areTechniciansPresent"}],"name":"areMoreTechPresent","description":"areMoreTechPresent","processRule":"typeof contextVar.dispatcherTechs !== 'undefined' && contextVar.dispatcherTechs.length > 0","nodeType":"DECISION"},"findNumberOfBatchesOfTechnician":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreTechPresent"}],"contextChangePermitted":true,"name":"findNumberOfBatchesOfTechnician","description":"findNumberOfBatchesOfTechnician","processRule":"{contextVar.noOfBatchesOfTech = Math.ceil(contextVar.dispatcherTechs.length / contextVar.customBatchSize);contextVar.originalTechnicianArray = JSON.parse(JSON.stringify(contextVar.dispatcherTechs));}","nodeType":"PROCESS"},"areTechniciansPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getOnlineStatusOfTechnicians"},{"exitPortType":"FalseStep","nodeId":"processFinalData"}],"name":"areTechniciansPresent","description":"Use this for decision in workflow","processRule":"(contextVar.allTechnicianData != '' && contextVar.allTechnicianData.length>0)","id":"areTechniciansPresent","nodeType":"DECISION"},"isTechnicianPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getDispatcherTechsTaskData"},{"exitPortType":"FalseStep","nodeId":"fetchTechnicianData"}],"name":"isTechnicianPresent","description":"isTechnicianPresent","processRule":"contextVar.filterApplied === true","nodeType":"DECISION"}}