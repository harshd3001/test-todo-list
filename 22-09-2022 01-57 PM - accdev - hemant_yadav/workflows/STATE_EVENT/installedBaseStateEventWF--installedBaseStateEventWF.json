{"insertIntoAssetLog":{"connectors":[{"exitPortType":"NextStep","nodeId":"isDecommissionedAsset"}],"processId":"installedBaseLogModelWF","name":"insertIntoAssetLog","description":"insertIntoAssetLog","inputVarMap":{"installedBaseLog":"installedBaseLog","subAction":"subAction"},"outputVarMap":{},"nodeType":"WORKFLOW"},"fetchLocalizedKeys":{"filter":"{$listOptionAnswer.listOptionId}='assetLogEvents'","models":["listOptionAnswer"],"connectors":[{"exitPortType":"NextStep","nodeId":"processModelData"}],"columns":{"listOptionAnswerId":"listOptionAnswer.id","listOptionAnswerAnswerOptionText":"listOptionAnswer.answerOptionText"},"name":"fetchLocalizedKeys","description":"fetchLocalizedKeys","outputVarMap":{"data":"localizedData"},"nodeType":"QUERY"},"start":{"connectors":[{"exitPortType":"NextStep","nodeId":"fetchLocalizedKeys"}],"name":"Start","description":"Start","nodeType":"START"},"assetMaintenancePlanInstalledBaseProcessEvent":{"eventId":"assetMaintenancePlanInstalledBaseProcessEvent","connectors":[{"exitPortType":"NextStep","nodeId":"fetchTasksAttachedToAsset"}],"multirecord":true,"name":"assetMaintenancePlanInstalledBaseProcessEvent","description":"assetMaintenancePlanInstalledBaseProcessEvent","inputVarMap":{"subActionForAssetMaintenancePlanInstalledBase":"subAction","assetMaintenancePlanInstalledBase":"assetMaintenancePlanInstalledBase"},"outputVarMap":{},"nodeType":"PUBLISH"},"workflowNodes":["start","fetchLocalizedKeys","processModelData","insertIntoAssetLog","isDecommissionedAsset","getAssetMaintenancePlanInstalledBaseData","areThereMaintenancePlanAssetsToBeDeleted","assetMaintenancePlanInstalledBaseProcessEvent","fetchMaintenancePlansWithNoActiveAsset","areThereAnyMaintenancePlansToExpire","processAssetMaintenancePlanInstalledBaseData","upsertAssetMaintenancePlanInstalledBase","fetchTasksAttachedToAsset","checkIfTasksExist","deleteAssetForTasks","end"],"deleteAssetForTasks":{"modelName":"workOrderTaskInstalledBase","connectors":[{"exitPortType":"NextStep","nodeId":"end"}],"multirecord":true,"name":"deleteAssetForTasks","description":"deleteAssetForTasks","inputVarMap":{"workOrderTaskInstalledBaseIdList":"data"},"nodeType":"MODEL","operation":3},"checkIfTasksExist":{"connectors":[{"exitPortType":"TrueStep","nodeId":"deleteAssetForTasks"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"checkIfTasksExist","description":"checkIfTasksExist","processRule":"Array.isArray(contextVar.workOrderTaskInstalledBaseIdList) && contextVar.workOrderTaskInstalledBaseIdList.length>0","nodeType":"DECISION"},"fetchMaintenancePlansWithNoActiveAsset":{"models":["installedBase","assetMaintenancePlanInstalledBase"],"connectors":[{"exitPortType":"NextStep","nodeId":"areThereAnyMaintenancePlansToExpire"}],"havingClause":"assetsCount = 0","columns":{"assetsCount":"COUNT(CASE WHEN {$installedBase.statusId} = 'installedBaseActive' THEN 1 ELSE NULL END)","id":"assetMaintenancePlanInstalledBase.assetMaintenancePlanId"},"inputs":{"assetMaintenancePlanIds":{"filter":"{$assetMaintenancePlanInstalledBase.installedBaseId} = {@id}","models":["assetMaintenancePlanInstalledBase"],"columns":{"assetMaintenancePlanId":"assetMaintenancePlanInstalledBase.assetMaintenancePlanId"},"name":"assetMaintenancePlanIds","distinct":true,"description":"assetMaintenancePlanIds","inputVarMap":{},"selectColumns":["assetMaintenancePlanId"]}},"description":"fetchMaintenancePlansWithNoActiveAsset","inputVarMap":{"id":"id"},"groupBy":"id","nodeType":"QUERY","filter":"{$id} IN ({@assetMaintenancePlanIds})","name":"fetchMaintenancePlansWithNoActiveAsset","links":{"installedBase":"assetMaintenancePlanInstalledBase"},"outputVarMap":{"data":"assetMaintenancePlan"},"batchSize":1000,"getCount":true},"upsertAssetMaintenancePlanInstalledBase":{"connectors":[{"exitPortType":"NextStep","nodeId":"getAssetMaintenancePlanInstalledBaseData"}],"processId":"assetMaintenancePlanWF","name":"upsertAssetMaintenancePlanInstalledBase","description":"upsertAssetMaintenancePlanInstalledBase","inputVarMap":{"subActionForPlan":"subActionForPlan","assetMaintenancePlan":"assetMaintenancePlan"},"nodeType":"WORKFLOW"},"getAssetMaintenancePlanInstalledBaseData":{"filter":"{$installedBaseId} = {@id}","models":["assetMaintenancePlanInstalledBase","installedBase"],"connectors":[{"exitPortType":"NextStep","nodeId":"areThereMaintenancePlanAssetsToBeDeleted"}],"columns":{"assetMaintenancePlanId":"assetMaintenancePlanInstalledBase.assetMaintenancePlanId","installedBaseId":"assetMaintenancePlanInstalledBase.installedBaseId"},"name":"getAssetMaintenancePlanInstalledBaseData","description":"getAssetMaintenancePlanInstalledBaseData","inputVarMap":{"id":"id"},"links":{"assetMaintenancePlanInstalledBase":"installedBase"},"outputVarMap":{"data":"assetMaintenancePlanInstalledBase"},"nodeType":"QUERY"},"workflowContext":{"subActionForAssetMaintenancePlanInstalledBase":"deleteAssetMaintenancePlanInstalledBase","subActionForPlan":"upsertAssetMaintenancePlan","statusIds":["workOrderTaskOpen","workOrderTaskScheduled","workOrderTaskDraft","workOrderTaskReopened"]},"areThereMaintenancePlanAssetsToBeDeleted":{"connectors":[{"exitPortType":"TrueStep","nodeId":"assetMaintenancePlanInstalledBaseProcessEvent"},{"exitPortType":"FalseStep","nodeId":"fetchTasksAttachedToAsset"}],"name":"areThereMaintenancePlanAssetsToBeDeleted","description":"areThereMaintenancePlanAssetsToBeDeleted","processRule":"typeof contextVar.assetMaintenancePlanInstalledBase !=='undefined' && contextVar.assetMaintenancePlanInstalledBase !=='' &&contextVar.assetMaintenancePlanInstalledBase.length>0","nodeType":"DECISION"},"fetchTasksAttachedToAsset":{"filter":"{$workOrderTaskInstalledBase.installedBaseId} = {@id} AND {$workOrderTask.statusId} IN {@statusIds}","models":["workOrderTaskInstalledBase","workOrderTask"],"connectors":[{"exitPortType":"NextStep","nodeId":"checkIfTasksExist"}],"columns":{"workOrderTaskInstalledBaseId":"workOrderTaskInstalledBase.zid","workOrderTaskId":"workOrderTaskInstalledBase.workOrderTaskId","installedBaseId":"workOrderTaskInstalledBase.installedBaseId"},"name":"fetchTasksAttachedToAsset","description":"fetchTasksAttachedToAsset","inputVarMap":{"id":"id","statusIds":"statusIds"},"links":{"workOrderTask":"workOrderTaskInstalledBase"},"outputVarMap":{"data":"workOrderTaskInstalledBaseIdList"},"nodeType":"QUERY"},"isDecommissionedAsset":{"connectors":[{"exitPortType":"TrueStep","nodeId":"fetchMaintenancePlansWithNoActiveAsset"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"isDecommissionedAsset","description":"isDecommissionedAsset","processRule":"typeof contextVar.statusId !=='undefined' && contextVar.statusId==='installedBaseDecommissioned'","nodeType":"DECISION"},"areThereAnyMaintenancePlansToExpire":{"connectors":[{"exitPortType":"TrueStep","nodeId":"processAssetMaintenancePlanInstalledBaseData"},{"exitPortType":"FalseStep","nodeId":"getAssetMaintenancePlanInstalledBaseData"}],"name":"areThereAnyMaintenancePlansToExpire","description":"areThereAnyMaintenancePlansToExpire","processRule":"typeof contextVar.assetMaintenancePlan !=='undefined' && contextVar.assetMaintenancePlan.length>0","nodeType":"DECISION"},"processAssetMaintenancePlanInstalledBaseData":{"connectors":[{"exitPortType":"NextStep","nodeId":"upsertAssetMaintenancePlanInstalledBase"}],"contextChangePermitted":true,"name":"processModelData","description":"processModelData","processRule":"{ for(let index in contextVar.assetMaintenancePlan){ delete contextVar.assetMaintenancePlan[index].assetsCount; contextVar.assetMaintenancePlan[index].statusId = 'assetMaintenancePlanExpired'; } }","nodeType":"PROCESS","jsEngine":"es6"},"end":{"name":"end","description":"end","inputVarMap":{},"outputVarMap":{},"nodeType":"END"},"processModelData":{"connectors":[{"exitPortType":"NextStep","nodeId":"insertIntoAssetLog"}],"contextChangePermitted":true,"name":"processModelData","description":"processModelData","processRule":"{ for (const key in contextVar.data) { contextVar[key] = contextVar.data[key]; } var localizedKeys = {}; if (typeof contextVar.localizedData !== 'undefined' && contextVar.localizedData !== '') { contextVar.localizedData.forEach(function (element) { localizedKeys[element.listOptionAnswerId] = element.listOptionAnswerAnswerOptionText; }); } contextVar.installedBaseLog = [{ loggedByUserId: contextVar.modifiedByUser, logDate: contextVar.modifiedDate, installedBaseId: contextVar.id }]; switch (contextVar.statusId) { case 'installedBaseActive': if (contextVar.createdDate === contextVar.modifiedDate) { contextVar.installedBaseLog[0].eventType = 'assetInstalled'; contextVar.installedBaseLog[0].event = localizedKeys['assetInstalled']; } else { contextVar.installedBaseLog[0].eventType = 'assetReactivated'; contextVar.installedBaseLog[0].event = localizedKeys['assetReactivated']; } break; case 'installedBaseDecommissioned': contextVar.installedBaseLog[0].eventType = 'assetDecommissioned'; contextVar.installedBaseLog[0].event = localizedKeys['assetDecommissioned']; break; } contextVar.subAction = 'upsertInstalledBaseLog'; }","nodeType":"PROCESS","jsEngine":"es6"}}