{"fetchInstances":{"filter":"{$ZProcessInstance.mainTitle} = {@taskId} AND {$ZProcessInstance.assignedToUserId} in {@memberList}","models":["ZProcessInstance"],"connectors":[{"exitPortType":"NextStep","nodeId":"areInstancesPresent"}],"columns":{"resumeKey":"ZProcessInstance.resumeKey","estimatedDurationInHours":"ZProcessInstance.estimatedDurationInHours","processId":"ZProcessInstance.processId","workOrderTaskScheduledDate":"ZProcessInstance.plannedStartTime","id":"ZProcessInstance.id","userId":"ZProcessInstance.assignedToUserId"},"name":"fetchInstances","description":"fetchInstances","inputVarMap":{"memberList":"memberList","workOrderTaskId":"taskId"},"outputVarMap":{"data":"fetchInstances"},"nodeType":"QUERY"},"processInstanceId":{"connectors":[{"exitPortType":"NextStep","nodeId":"loopThroughInstances"}],"contextChangePermitted":true,"name":"processInstanceId","description":"processInstanceId","processRule":"if (typeof contextVar.zProcessInstanceData1 !== 'undefined' && contextVar.zProcessInstanceData1 !== '' && Array.isArray(contextVar.zProcessInstanceData1)) { var obj = { 'workOrderTaskId': contextVar.workOrderTaskId, 'workforceUserId': contextVar.assignedToUserId, 'processInstanceId': contextVar.zProcessInstanceData1[0].zProcessInstanceId ? contextVar.zProcessInstanceData1[0].zProcessInstanceId : '' }; contextVar.updatedInstance.push(obj); contextVar.crewAttendanceData = contextVar.updatedInstance;}","nodeType":"PROCESS"},"createInstance":{"connectors":[{"exitPortType":"NextStep","nodeId":"getInstanceId"}],"name":"createInstance","description":"createInstance","inputVarMap":{"workOrderTaskId":"workOrderTaskId","submitForInstance":"submitType","workOrderTaskScheduledDate":"{@plannedStartTime}","workOrderTaskEstimatedDuration":"workOrderTaskEstimatedDuration","mobileProcessId":"processId","userId":"assignedToUserId","timeTakenForTask":"{@estimatedDurationInHours}"},"outputVarMap":{"zProcessInstanceId":"zProcessInstanceId"},"execType":"fork","nodeType":"WORKFLOW"},"getInstanceId":{"filter":"{$ZProcessInstance.mainTitle} = {@workOrderTaskId} AND {$ZProcessInstance.assignedToUserId} = {@userId}","models":["ZProcessInstance"],"connectors":[{"exitPortType":"NextStep","nodeId":"processInstanceId"}],"columns":{"createdDate":"ZProcessInstance.createdDate","zProcessInstanceId":"ZProcessInstance.id"},"name":"getInstanceId","description":"getInstanceId","inputVarMap":{"assignedToUserId":"userId","workOrderTaskId":"workOrderTaskId"},"outputVarMap":{"data":"zProcessInstanceData1"},"batchSize":"1","nodeType":"QUERY"},"deleteProcessInstanceDecision":{"connectors":[{"exitPortType":"TrueStep","nodeId":"deleteInstance"},{"exitPortType":"FalseStep","nodeId":"loopThroughInstances"}],"name":"deleteProcessInstanceDecision","description":"deleteProcessInstanceDecision","processRule":"(typeof contextVar.resumeKey !== 'undefined' && contextVar.resumeKey !== '' && typeof contextVar.instanceId !== 'undefined' && contextVar.instanceId !== '')","nodeType":"DECISION"},"logger":{"connectors":[{"exitPortType":"NextStep","nodeId":"isPartialAccess"}],"name":"logger","description":"Provide some description for your logger node","inputVarMap":{"logLevel":"logLevel","message":"message"},"id":"logger","nodeType":"LOGGER"},"start":{"connectors":[{"exitPortType":"NextStep","nodeId":"isPartialAccess"}],"name":"start","description":" Start","id":"start","nodeType":"START"},"isPartialAccess":{"connectors":[{"exitPortType":"TrueStep","nodeId":"processData"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"isPartialAccess","description":"isPartialAccess","processRule":"(contextVar.crewMobileAccess === 'partialAccess')","nodeType":"DECISION"},"processAttendanceDetails":{"connectors":[{"exitPortType":"NextStep","nodeId":"checkIfUpdateRequired"}],"contextChangePermitted":true,"name":"processAttendanceDetails","description":"processAttendanceDetails","processRule":"function dateCompare(d1, d2) { return (new Date(d1).getTime() > new Date(d2).getTime()); } let endTime = ''; contextVar.crewAttendanceData = []; if (contextVar.submitType == 'endTask') { if (contextVar.submitTaskTime) { endTime = contextVar.submitTaskTime; } } if (contextVar.submitType == 'submitTaskProgress' || contextVar.submitType == 'checkOut') { if (contextVar.checkOutCheckBoxForSubmitCapturedTime) { endTime = contextVar.checkOutCheckBoxForSubmitCapturedTime; } } endTime = endTime ? endTime : new Date().toISOString().replace('T', ' ').replace('Z', ''); if (Array.isArray(contextVar.prevAttendanceDetails)) { contextVar.prevAttendanceDetails.forEach(function (element) { if (typeof element.attendance != 'undefined' && element.attendance.length > 0) { element.attendance.forEach(function (ele) { if (ele.checkInTime && ele.checkOutTime) { if (dateCompare(ele.checkInTime, ele.checkOutTim)) { ele.checkOutTime = endTime; } } else { if (ele.checkInTime) { ele.checkOutTime = endTime; } } }); } contextVar.crewAttendanceData.push(element); }); }","nodeType":"PROCESS","jsEngine":"es6"},"updateCrewAttendance":{"connectors":[{"exitPortType":"NextStep","nodeId":"processDataForInstanceCreation"}],"processId":"AJE55L9RXN","name":"updateCrewAttendance","description":"updateCrewAttendance","inputVarMap":{"crewAttendanceData":"data"},"nodeType":"WORKFLOW"},"workflowNodes":["start","processData1","logger","isPartialAccess","processData","isPartialAccessForLead","fetchAttendanceDetails","processAttendanceDetails","checkIfUpdateRequired","updateCrewAttendance","processDataForInstanceCreation","fetchInstances","areInstancesPresent","loopThroughInstances","parseInstanceData","deleteProcessInstanceDecision","deleteInstance","createInstance","getInstanceId","processInstanceId","updatePartialAccessInstance","end"],"checkIfUpdateRequired":{"connectors":[{"exitPortType":"TrueStep","nodeId":"updateCrewAttendance"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"checkIfUpdateRequired","description":"check if update required for crew attendance","processRule":"(typeof contextVar.crewAttendanceData !== 'undefined' && Array.isArray(contextVar.crewAttendanceData) && contextVar.crewAttendanceData.length > 0)","nodeType":"DECISION"},"processDataForInstanceCreation":{"connectors":[{"exitPortType":"NextStep","nodeId":"fetchInstances"}],"contextChangePermitted":true,"name":"processData","description":"processData","processRule":"contextVar.memberList = []; contextVar.prevAttendanceDetails.forEach((obj)=>{ contextVar.memberList.push(obj.workforceUserId); });","nodeType":"PROCESS","jsEngine":"es6"},"updatePartialAccessInstance":{"modelName":"crewAttendance","connectors":[{"exitPortType":"NextStep","nodeId":"end"}],"multirecord":true,"name":"updatePartialAccessInstance","description":"updatePartialAccessInstance","inputVarMap":{"crewAttendanceData":"data"},"id":"updatePartialAccessInstance","outputVarMap":{"data":"crewAttendanceDataObj"},"nodeType":"MODEL","operation":4},"processData1":{"connectors":[{"exitPortType":"NextStep","nodeId":"logger"}],"contextChangePermitted":true,"name":"processData1","description":"Processing site data and task details","processRule":"contextVar.logLevel = 'INFO'; contextVar.message='Partial access pp wf contextVar = '+ JSON.stringify(contextVar);","id":"processData1","nodeType":"PROCESS"},"processData":{"connectors":[{"exitPortType":"NextStep","nodeId":"isPartialAccessForLead"}],"contextChangePermitted":true,"name":"processData","description":"processData","processRule":"contextVar.leadUserId = Array.isArray(contextVar.leadDetails) ? contextVar.leadDetails[0].leadUserId : contextVar.leadUserId; contextVar.assignedToUserId = contextVar.assignedToUserId ? contextVar.assignedToUserId : contextVar['__sys__loggedIn_UserId']; if (contextVar.backedUpData){ contextVar.checkOutCheckBoxForSubmitCapturedTime = contextVar.checkOutCheckBoxForSubmitCapturedTime || contextVar.backedUpData.checkOutCheckBoxForSubmitCapturedTime; contextVar.checkOutCheckBoxForSubmit = contextVar.checkOutCheckBoxForSubmit || contextVar.backedUpData.checkOutCheckBoxForSubmit; contextVar.checkOutCheckBoxForSubmitLocationCoordinates = contextVar.checkOutCheckBoxForSubmitLocationCoordinates || contextVar.backedUpData.checkOutCheckBoxForSubmitLocationCoordinates; }","nodeType":"PROCESS"},"isPartialAccessForLead":{"connectors":[{"exitPortType":"TrueStep","nodeId":"fetchAttendanceDetails"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"isPartialAccessForLead","description":"isPartialAccessForLead","processRule":"((contextVar.leadUserId === contextVar.assignedToUserId) && ((contextVar.checkOutCheckBoxForSubmit == 'true' && ( contextVar.submitType == 'submitTaskProgress' || contextVar.submitType == 'checkOut')) || contextVar.submitType == 'endTask'))","nodeType":"DECISION"},"fetchAttendanceDetails":{"filter":"{$workOrderTaskId} ={@workOrderTaskId} AND {$workforceCrew.statusId} ='workforceCrewOnCrew' AND {@leadUserId} != {$User.id}","models":["workOrderTask","crewAttendance","User","workforce","crew","workforceCrew"],"connectors":[{"exitPortType":"NextStep","nodeId":"processAttendanceDetails"}],"columns":{"workOrderTaskId":"crewAttendance.workOrderTaskId","workforceUserId":"crewAttendance.workforceUserId","attendance":"crewAttendance.attendance"},"name":"fetchAttendanceDetails","description":"fetchAttendanceDetails","distinct":true,"inputVarMap":{"assignedToUserId":"assignedToUserId","workOrderTaskId":"workOrderTaskId","leadUserId":"leadUserId"},"links":{"User":"workforce","crewAttendance":"workOrderTask","workforce":"crewAttendance","crew":"workOrderTask","workforceCrew":"crew"},"id":"fetchCrewAttendanceDetails","outputVarMap":{"data":"prevAttendanceDetails"},"nodeType":"QUERY"},"workflowContext":{"updatedInstance":[],"submitForInstance":""},"loopThroughInstances":{"connectors":[{"exitPortType":"TrueStep","nodeId":"parseInstanceData"},{"exitPortType":"FalseStep","nodeId":"updatePartialAccessInstance"}],"data":"fetchInstances","name":"loopThroughInstances","description":"loopThroughInstances","inputVarMap":{},"id":"loopThroughInstances","outputVarMap":{},"nodeType":"FOREACHLOOP"},"parseInstanceData":{"connectors":[{"exitPortType":"NextStep","nodeId":"deleteProcessInstanceDecision"}],"contextChangePermitted":true,"name":"setResumeKey","description":"setResumeKey","processRule":"contextVar.resumeKey = contextVar.loopThroughInstances_currentElement.resumeKey; contextVar.instanceId = contextVar.loopThroughInstances_currentElement.id;contextVar.assignedToUserId = contextVar.loopThroughInstances_currentElement.userId; contextVar.mobileProcessId = contextVar.loopThroughInstances_currentElement.processId;contextVar.timeTakenForTask = contextVar.timeTakenForTask ? contextVar.timeTakenForTask : parseInt(contextVar.loopThroughInstances_currentElement.estimatedDurationInHours); contextVar.workOrderTaskEstimatedDuration = contextVar.workOrderTaskEstimatedDuration ? contextVar.workOrderTaskEstimatedDuration : (contextVar.timeTakenForTask * 60); contextVar.userId = contextVar.loopThroughInstances_currentElement.userId; contextVar.workOrderTaskScheduledDate = contextVar.workOrderTaskScheduledDate ? contextVar.workOrderTaskScheduledDate : contextVar.loopThroughInstances_currentElement.workOrderTaskScheduledDate;","nodeType":"PROCESS"},"deleteInstance":{"connectors":[{"exitPortType":"NextStep","nodeId":"createInstance"}],"name":"deleteInstance","description":"deleteInstance","action":"cancel","inputVarMap":{"resumeKey":"resumeKey","instanceId":"instanceId"},"outputVarMap":{},"nodeType":"WORKFLOW"},"end":{"name":"end","description":"end","inputVarMap":{},"outputVarMap":{},"nodeType":"END"},"areInstancesPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"loopThroughInstances"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"areInstancesPresent","description":"areInstancesPresent","processRule":"((contextVar.submitType == 'submitTaskProgress' || contextVar.submitType == 'checkOut') && Array.isArray(contextVar.fetchInstances) && contextVar.fetchInstances.length > 0)","nodeType":"DECISION"}}