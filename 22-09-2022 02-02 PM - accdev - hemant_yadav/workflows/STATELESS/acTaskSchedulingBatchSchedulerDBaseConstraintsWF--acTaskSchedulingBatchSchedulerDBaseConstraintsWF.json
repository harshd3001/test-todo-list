{"isMobileTechnicianPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getSchedulerSettingData"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"isMobileTechnicianPresent","description":"isMobileTechnicianPresent","processRule":"(contextVar.isValid === true )","nodeType":"DECISION"},"processTaskData":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTechnician"}],"contextChangePermitted":true,"name":"processTaskData","description":"processTaskData","processRule":"{if(contextVar.taskData !== '' && typeof contextVar.taskData !== 'undefined' && contextVar.taskData.length > 0){contextVar.acPrimaryAppraiserId = contextVar.taskData[0].acPrimaryAppraiserId; contextVar.customerId = contextVar.taskData[0].customerId; contextVar.latitude = contextVar.taskData[0].latitude; contextVar.longitude = contextVar.taskData[0].longitude; contextVar.timestamp = +Math.floor(Date.now() / 1000);contextVar.location = contextVar.latitude + ' ' + contextVar.longitude; }}","nodeType":"PROCESS"},"getTimeZone":{"connectors":[{"exitPortType":"NextStep","nodeId":"getCalendarData"}],"processId":"FGWSS34F7Z","name":"getTimeZone","description":"getTimeZone","inputVarMap":{"latitude":"latitude","location":"location","longitude":"longitude","timestamp":"timestamp"},"outputVarMap":{"distance":"timeZoneOffsetData"},"nodeType":"WORKFLOW"},"processShiftData":{"connectors":[{"exitPortType":"NextStep","nodeId":"checkIfDataToBeUpsertedPresent"}],"contextChangePermitted":true,"name":"processShiftData","description":"processShiftData","processRule":"{ contextVar.appointmentWindowStartDate = ''; contextVar.appointmentWindowEndDate = ''; if (contextVar.entityData !== '' && typeof contextVar.entityData !== 'undefined') { contextVar.entityValue = contextVar.entityData[0].configValue; } var count = 1; for (var dayCount = 0; dayCount < 7; dayCount++) { for (var i = 0; i < contextVar.appointmentWindowData.length; i++) { var refer = '.000'; dayCount = 0; contextVar.appointmentWindowStartTime = contextVar.appointmentWindowData[i].appointmentWindowStartTime; contextVar.appointmentWindowId = contextVar.appointmentWindowData[i].appointmentWindowId; contextVar.appointmentWindowEndTime = contextVar.appointmentWindowData[i].appointmentWindowEndTime; for (var j = 0; j < contextVar.shiftData.length; j++) { if (contextVar.day == contextVar.shiftData[j].displayOrder) { if (contextVar.shiftData[j].schedule !== '' && contextVar.shiftData[j].schedule.length > 0) { if (contextVar.shiftData[j].schedule[0].start <= contextVar.appointmentWindowStartTime && contextVar.shiftData[j].schedule[0].end >= contextVar.appointmentWindowEndTime) { contextVar.appointmentWindowStartDate = contextVar.startDate.slice(0, 11).concat(contextVar.appointmentWindowStartTime); contextVar.appointmentWindowEndDate = contextVar.startDate.slice(0, 11).concat(contextVar.appointmentWindowEndTime); if (contextVar.calendarData !== '' && contextVar.calendarData.length > 0) { for (z = 0; z < contextVar.calendarData.length; z++) { if ((contextVar.appointmentWindowStartDate > contextVar.calendarData[z].startTime || contextVar.appointmentWindowEndDate < contextVar.calendarData[z].endTime)) {} else { contextVar.appointmentWindowStartDate = ''; contextVar.appointmentWindowEndDate = ''; } } } if (contextVar.appointmentWindowStartDate !== '' && contextVar.appointmentWindowEndDate !== '') { break; } } } } } if (contextVar.appointmentWindowStartDate !== '' && contextVar.appointmentWindowEndDate !== '') { break; } } if (contextVar.appointmentWindowStartDate !== '' && contextVar.appointmentWindowEndDate !== '') { break; } contextVar.day = contextVar.day + 1; contextVar.startDate = new Date(contextVar.startDate); contextVar.startDate = contextVar.startDate.toISOString().replace('T', ' ').replace('Z', ''); contextVar.startDate = new Date(contextVar.startDate.slice(0, 10)); contextVar.startDate.setDate(contextVar.startDate.getDate() + count); contextVar.startDate = contextVar.startDate.toISOString().replace('T', ' ').replace('Z', ''); if (contextVar.day > 6) { contextVar.day = 0; } } if (contextVar.entityValue !== '' && typeof contextVar.entityValue !== 'undefined') { contextVar.appointmentWindowEndDate = new Date(contextVar.appointmentWindowEndDate); contextVar.appointmentWindowEndDate.setMinutes(contextVar.appointmentWindowEndDate.getMinutes() + parseInt(contextVar.entityValue)); contextVar.appointmentWindowEndDate = contextVar.appointmentWindowEndDate.toISOString().replace('T', ' ').replace('Z', ''); } contextVar.startEndJson = []; contextVar.startEndJson.push({ 'start': contextVar.appointmentWindowStartDate, 'end': contextVar.appointmentWindowEndDate }) }","nodeType":"PROCESS","jsEngine":"es6"},"processAppointmentData":{"connectors":[{"exitPortType":"NextStep","nodeId":"processShiftData"}],"contextChangePermitted":true,"name":"processAppointmentData","description":"processAppointmentData","processRule":"{ if (contextVar.timeZoneOffsetData.length > 0) { contextVar.status = contextVar.timeZoneOffsetData[0].status; if (contextVar.status == 'OK') { var timezoneoffsetRaw = contextVar.timeZoneOffsetData[0].rawOffset; var timezoneoffsetDst = contextVar.timeZoneOffsetData[0].dstOffset; if (timezoneoffsetDst > 0) { timezoneoffsetAdded = timezoneoffsetRaw + timezoneoffsetDst; } else { timezoneoffsetAdded = timezoneoffsetRaw; } var truncate = function(v) { return v < 0 ? Math.ceil(v) : Math.floor(v); }; function timeZoneFormat(duration) { var hrs = truncate(duration / 3600); var mins = truncate((duration % 3600) / 60); var newmins = mins.toString().replace('-', ''); if (hrs > -1) { hrs = '+'.concat(hrs) } var ret = ''; if (parseInt(newmins) > 0) { ret += '' + hrs + ':' + newmins; } else { ret += '' + hrs; } return ret; } contextVar.timezoneoffset = timeZoneFormat(timezoneoffsetAdded); contextVar.timeZoneName = contextVar.timeZoneOffsetData[0].timeZoneName; } else { contextVar.timezoneoffset = 0; } } else { contextVar.timezoneoffset = 0; } contextVar.timeZone = contextVar.timezoneoffset; if (contextVar.timeZone !== '') { if (contextVar.timeZone.includes(':')) { contextVar.t = contextVar.timeZone.split(':'); contextVar.hrs = parseInt(contextVar.t[0]); contextVar.min = parseInt(contextVar.t[1]); } else { contextVar.t = parseInt(contextVar.timeZone); contextVar.hrs = contextVar.t; } contextVar.hrsMinutes = (contextVar.hrs * 60); if (typeof contextVar.min === 'undefined' || contextVar.min === '') { contextVar.min = 0; } contextVar.minMinutes = contextVar.hrsMinutes + contextVar.min; } if (contextVar.hrs > 0) { contextVar.minMinutes = contextVar.minMinutes * -1; } if (contextVar.t[0] > 0) { contextVar.minMinutes = contextVar.minMinutes * -1; } for (var i = 0; i < contextVar.appointmentWindowData.length; i++) { if (!isNaN(contextVar.minMinutes)) { contextVar.timezoneOffset1 = Number(contextVar.minMinutes); var addMinutes = function(date) { return (new Date(date.getTime() - (contextVar.timezoneOffset1 * 60000))).toISOString().replace('T', ' ').replace('Z', ''); }; contextVar.startTimeInUTC = addMinutes(new Date(contextVar.appointmentWindowData[i].appointmentWindowStartTime)); contextVar.endTimeInUTC = addMinutes(new Date(contextVar.appointmentWindowData[i].appointmentWindowEndTime)); contextVar.startDate1 = contextVar.startTimeInUTC; contextVar.endDate1 = contextVar.endTimeInUTC; contextVar.appointmentWindowData[i]['appointmentWindowStartTime'] = contextVar.startDate1.slice(11, 23); contextVar.appointmentWindowData[i]['appointmentWindowEndTime'] = contextVar.endDate1.slice(11, 23); } } for (var i = 0; i < contextVar.shiftData.length; i++) { if (!isNaN(contextVar.minMinutes)) { contextVar.timezoneOffset1 = Number(contextVar.minMinutes); var addMinutes = function(date) { return (new Date(date.getTime() - (contextVar.timezoneOffset1 * 60000))).toISOString().replace('T', ' ').replace('Z', ''); }; if (contextVar.shiftData[i].schedule !== '' && contextVar.shiftData[i].schedule.length > 0) { contextVar.startTimeInUTC = addMinutes(new Date(contextVar.shiftData[i].schedule[0].start)); contextVar.endTimeInUTC = addMinutes(new Date(contextVar.shiftData[i].schedule[0].end)); contextVar.startDate2 = contextVar.startTimeInUTC; contextVar.endDate2 = contextVar.endTimeInUTC; contextVar.shiftData[i].schedule[0].start = contextVar.startDate2.slice(11, 23); contextVar.shiftData[i].schedule[0].end = contextVar.endDate2.slice(11, 23); } } } }","nodeType":"PROCESS","jsEngine":"es6"},"processTechData":{"connectors":[{"exitPortType":"NextStep","nodeId":"isMobileTechnicianPresent"}],"contextChangePermitted":true,"name":"processTechData","description":"processTechData","processRule":"{ if (Array.isArray(contextVar.technicianData) && contextVar.technicianData.length > 0) { contextVar.isValid = true; } }","nodeType":"PROCESS"},"checkTechnicianWorkGroupEligibility":{"connectors":[{"exitPortType":"NextStep","nodeId":"end"}],"contextChangePermitted":true,"name":"checkTechnicianWorkGroupEligibility","description":"checkTechnicianWorkGroupEligibility","processRule":"{ contextVar.isValid = false; let objectMap = {}; let workGroupFilter = ['region', 'customer', 'workOrderType', 'taskType']; if (Array.isArray(contextVar.userWorkGroupFilterData) && contextVar.userWorkGroupFilterData.length > 0) { for (let value of contextVar.userWorkGroupFilterData) { if (value.filterMethod === 'all') { contextVar.isValid = true; break; } if (typeof objectMap[value.filterMethod] === 'undefined') { objectMap[value.filterMethod] = []; } objectMap[value.filterMethod].push(value.filterId); } if (!contextVar.isValid) { contextVar.isValid = true; for (let val of workGroupFilter) { if (val in objectMap) { if (!(objectMap[val].indexOf(contextVar[`${val}Id`]) > -1)) { contextVar.isValid = false; break; } } } } } }","nodeType":"PROCESS","jsEngine":"es6"},"workflowContext":{"customBatchSize":1000,"featureName":"batchScheduler","isValid":false,"extraMsg":"BASE CONSTRAINTS: taskSchedulingBatchSchedulerBaseConstraintsWF call"},"getTechnician":{"filter":"{$appraiserId} = {@acPrimaryAppraiserId} && {$clientId} = {@customerId} && {$analystId} = {@techId} ","models":["acClientApprovedWorkforce","workforce"],"connectors":[{"exitPortType":"NextStep","nodeId":"processTechData"}],"columns":{"availabilityWithOverTime":"workforce.userId","clientId":"acClientApprovedWorkforce.clientId","calendarId":"workforce.calendarId","id":"acClientApprovedWorkforce.id","analystId":"acClientApprovedWorkforce.analystId","appraiserId":"acClientApprovedWorkforce.appraiserId"},"name":"getTechnician","description":"getTechnician","distinct":true,"links":{"acClientApprovedWorkforce":"workforce"},"inputVarMap":{"acPrimaryAppraiserId":"acPrimaryAppraiserId","taskTypeMobileProcessId":"taskTypeMobileProcessId","customerId":"customerId","techId":"techId"},"outputVarMap":{"data":"technicianData"},"nodeType":"QUERY","getCount":true},"getCalendarData":{"filter":"{$startTime} > {@startTime} && {$userId} IN {@userList}","models":["techCalendarV2"],"connectors":[{"exitPortType":"NextStep","nodeId":"processAppointmentData"}],"columns":{"workOrderTaskId":"techCalendarV2.workOrderTaskId","startTime":"techCalendarV2.startTime","endTime":"techCalendarV2.endTime","id":"techCalendarV2.id","userId":"techCalendarV2.userId"},"name":"getCalendarData","description":"getCalendarData","distinct":true,"inputVarMap":{"userList":"userList","startTime":"startTime"},"outputVarMap":{"data":"calendarData"},"nodeType":"QUERY","getCount":true},"getShifts":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTimeZone"}],"processId":"acFetchTechsAndSitesAvailabilityWF","name":"getShifts","description":"getShifts","inputVarMap":{"userList":"technicians","calendarId":"calendarId","endDate":"endDate","startDate":"startDate"},"outputVarMap":{},"nodeType":"WORKFLOW"},"processSkillLevelData":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTaskAppointmentWindow"}],"contextChangePermitted":true,"name":"processSkillLevelData","description":"processSkillLevelData","processRule":"{ if (Array.isArray(contextVar.taskTypeSkill) && contextVar.taskTypeSkill.length > 0) { if (typeof contextVar.techniciansSkill !== 'undefined') { for (var element of contextVar.taskTypeSkill) { if (typeof contextVar.techniciansSkill[element.skillId] === 'undefined' || contextVar.techniciansSkill[element.skillId] < element.skillLevelRank) { contextVar.isValid = false; break; } } } else { contextVar.isValid = false; } } }","nodeType":"PROCESS","jsEngine":"es6"},"end":{"name":"end","description":"End","inputVarMap":{"appointmentWindowEndDate":"appointmentWindowEndDate","isValid":"isValid","appointmentWindowStartDate":"appointmentWindowStartDate"},"outputVarMap":{"isValid":"isValid"},"nodeType":"END"},"isSkillFilterApplicable":{"connectors":[{"exitPortType":"TrueStep","nodeId":"processSkillLevelData"},{"exitPortType":"FalseStep","nodeId":"getEligibleTechnicianIds"}],"name":"isSkillFilterApplicable","description":"isSkillFilterApplicable","processRule":"(contextVar.schedulerSettingUseSkills === true )","nodeType":"DECISION"},"getTaskAppointmentWindow":{"filter":"{$workOrderTaskId} = {@workOrderTaskId}","models":["workOrderTaskAppointmentWindow"],"connectors":[{"exitPortType":"NextStep","nodeId":"isAppointmentSkillPresent"}],"columns":{"appointmentWindowId":"workOrderTaskAppointmentWindow.appointmentWindowId","recver":"recver","endDate":"workOrderTaskAppointmentWindow.endDate","workOrderTaskId":"workOrderTaskAppointmentWindow.workOrderTaskId","id":"workOrderTaskAppointmentWindow.id","startDate":"workOrderTaskAppointmentWindow.startDate"},"name":"getTaskAppointmentWindow","description":"getTaskAppointmentWindow","distinct":true,"inputVarMap":{"workOrderTaskId":"workOrderTaskId"},"outputVarMap":{"data":"taskAppointmentWindowData"},"nodeType":"QUERY","getCount":true},"isAppointmentSkillPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getAppointmentWindow"},{"exitPortType":"FalseStep","nodeId":"isSkillPresent"}],"name":"isAppointmentSkillPresent","description":"isAppointmentSkillPresent","processRule":"( contextVar.isValid === true && contextVar.taskAppointmentWindowData.length == 0)","nodeType":"DECISION"},"getTaskData":{"filter":"{$id} = {@workOrderTaskId}","models":["workOrderTask","workOrder","site"],"connectors":[{"exitPortType":"NextStep","nodeId":"processTaskData"}],"columns":{"acPrimaryAppraiserId":"workOrder.acPrimaryAppraiserId","latitude":"site.latitude","customerId":"workOrder.customerId","id":"workOrderTask.id","longitude":"site.longitude"},"name":"getTaskData","description":"getTaskData","distinct":true,"outerJoinOnModel":"workOrderTask","inputVarMap":{"workOrderTaskId":"workOrderTaskId"},"outputVarMap":{"data":"taskData"},"nodeType":"QUERY","getCount":true},"start":{"connectors":[{"exitPortType":"NextStep","nodeId":"logContextVar"}],"name":"start","description":"Start","nodeType":"START"},"logContextVar":{"connectors":[{"exitPortType":"NextStep","nodeId":"processData"}],"processId":"featureLoggerWF","name":"logContextVar","description":"logContextVar","inputVarMap":{"featureName":"featureName","extraMsg":"extraMsg"},"id":"logContextVar","outputVarMap":{},"nodeType":"WORKFLOW"},"checkIfDataToBeUpsertedPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"upsertWorkOrderTaskAppointmentWindow"},{"exitPortType":"FalseStep","nodeId":"checkTechnicianWorkGroupEligibility"}],"name":"checkIfDataToBeUpsertedPresent","description":"checkIfDataToBeUpsertedPresent","processRule":"contextVar.appointmentWindowStartDate !== '' && typeof contextVar.appointmentWindowStartDate !== 'undefined' ","nodeType":"DECISION"},"processSchedulerSettingData":{"connectors":[{"exitPortType":"NextStep","nodeId":"isSkillFilterApplicable"}],"contextChangePermitted":true,"name":"processSchedulerSettingData","description":"processSchedulerSettingData ","processRule":"{ if (typeof contextVar.schedulerSettingData != 'undefined' && contextVar.schedulerSettingData.length > 0) { contextVar.schedulerSettingUseSkills = contextVar.schedulerSettingData[0].schedulerSettingUseSkills; contextVar.acPrebookDays = contextVar.schedulerSettingData[0].acPrebookDays; } else { contextVar.schedulerSettingUseSkills = false; } contextVar.startDate = new Date(); contextVar.day = contextVar.startDate.getDay() + 1; contextVar.startDate.setDate(contextVar.startDate.getDate() + 1); contextVar.startDate = contextVar.startDate.toISOString().replace('T', ' ').replace('Z', ''); contextVar.startTime = contextVar.startDate.slice(0, 10); contextVar.endDate = new Date(); contextVar.endDate.setDate(contextVar.endDate.getDate() + contextVar.acPrebookDays); contextVar.endDate = contextVar.endDate.toISOString().replace('T', ' ').replace('Z', ''); }","nodeType":"PROCESS"},"workflowNodes":["start","logContextVar","processData","getTaskData","processTaskData","getTechnician","processTechData","isMobileTechnicianPresent","getSchedulerSettingData","processSchedulerSettingData","isSkillFilterApplicable","processSkillLevelData","getTaskAppointmentWindow","isAppointmentSkillPresent","getAppointmentWindow","getEntityData","getShifts","getTimeZone","getCalendarData","processAppointmentData","processShiftData","checkIfDataToBeUpsertedPresent","upsertWorkOrderTaskAppointmentWindow","isSkillPresent","getEligibleTechnicianIds","checkTechnicianWorkGroupEligibility","end"],"getSchedulerSettingData":{"models":["schedulerSetting"],"connectors":[{"exitPortType":"NextStep","nodeId":"processSchedulerSettingData"}],"columns":{"schedulerSettingUseSkills":"schedulerSetting.useSkills","acPrebookDays":"schedulerSetting.acPrebookDays"},"name":"getSchedulerSettingData","description":"getSchedulerSettingData","distinct":true,"inputVarMap":{},"outputVarMap":{"data":"schedulerSettingData"},"nodeType":"QUERY","getCount":true},"getAppointmentWindow":{"models":["appointmentWindow"],"connectors":[{"exitPortType":"NextStep","nodeId":"getEntityData"}],"columns":{"appointmentWindowId":"appointmentWindow.id","appointmentWindowStartTime":"appointmentWindow.startTime","appointmentWindowMaxTasks":"appointmentWindow.maxTasks","appointmentWindowName":"appointmentWindow.name","appointmentWindowEndTime":"appointmentWindow.endTime","appointmentWindowRecver":"appointmentWindow.recver","appointmentWindowDescription":"appointmentWindow.description"},"name":"getAppointmentWindow","orderBy":"appointmentWindowStartTime","description":"getAppointmentWindow","distinct":true,"inputVarMap":{"workOrderTaskId":"workOrderTaskId"},"outputVarMap":{"data":"appointmentWindowData"},"nodeType":"QUERY","getCount":true},"processData":{"connectors":[{"exitPortType":"NextStep","nodeId":"getTaskData"}],"contextChangePermitted":true,"name":"processData","description":"processData","processRule":"{ contextVar.userList = []; contextVar.userList.push(contextVar.tech.id); contextVar.techId = contextVar.tech.id; contextVar.workOrderTaskId = contextVar.taskDetail.id; contextVar.techniciansSkill = contextVar.tech.techniciansSkill; for (var key in contextVar.taskDetail) { contextVar[key] = contextVar.taskDetail[key]; } }","nodeType":"PROCESS"},"isSkillPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getEligibleTechnicianIds"},{"exitPortType":"FalseStep","nodeId":"end"}],"name":"isSkillPresent","description":"isSkillPresent","processRule":"( contextVar.isValid === true )","nodeType":"DECISION"},"upsertWorkOrderTaskAppointmentWindow":{"modelName":"workOrderTaskAppointmentWindow","connectors":[{"exitPortType":"NextStep","nodeId":"isSkillPresent"}],"name":"upsertWorkOrderTaskAppointmentWindow","description":"upsertModel","inputVarMap":{"appointmentWindowId":"appointmentWindowId","appointmentWindowEndDate":"endDate","appointmentWindowStartDate":"startDate","workOrderTaskId":"workOrderTaskId","startEndJson":"startEndJson"},"outputVarMap":{"data":"workOrderTaskAppointmentWindowUpsertedData"},"nodeType":"MODEL","operation":1},"getEligibleTechnicianIds":{"connectors":[{"exitPortType":"NextStep","nodeId":"checkTechnicianWorkGroupEligibility"}],"processId":"userWorkGroupFilterWF","name":"getEligibleTechnicianIds","description":"getEligibleTechnicianIds","inputVarMap":{"userList":"userList"},"outputVarMap":{},"nodeType":"WORKFLOW"},"getEntityData":{"filter":"( {$configKey}  =  'acApptWdwBuffer')","models":["EntityConfig"],"connectors":[{"exitPortType":"NextStep","nodeId":"getShifts"}],"columns":{"configKey":"EntityConfig.configKey","encrypted":"EntityConfig.encrypted","recver":"EntityConfig.recver","valueType":"EntityConfig.valueType","configScope":"EntityConfig.configScope","configValue":"EntityConfig.configValue"},"name":"getEntityData","description":"getEntityData","distinct":true,"inputVarMap":{},"outputVarMap":{"data":"entityData"},"nodeType":"QUERY","getCount":true}}