{"autoCancelWorkOrderTasks":{"connectors":[{"exitPortType":"NextStep","nodeId":"end"}],"contextChangePermitted":true,"processId":"QIFGIU7FDJ","name":"autoCancelWorkOrderTasks","description":"autoCancelWorkOrderTasks","inputVarMap":{"cancellationSubAction":"subAction","cancellationReason":"workOrderTaskCancellationReason","customerId":"customerId"},"id":"autoCancelWorkOrderTasks","nodeType":"WORKFLOW"},"setCustomerSitesStatusDeactivated":{"connectors":[{"exitPortType":"NextStep","nodeId":"findNumberOfBatches"}],"contextChangePermitted":true,"name":"setCustomerSitesStatusDeactivated","description":"setCustomerSitesStatusDeactivated","processRule":"{contextVar.siteSubAction='deactivateCustomerSite';}","nodeType":"PROCESS"},"findNumberOfBatches":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreBatchesPresent"}],"contextChangePermitted":true,"name":"findNumberOfBatches","description":"findNumberOfBatches","processRule":"{ contextVar.noOfSitesBatches = Math.ceil(contextVar.sitesCount / contextVar.customBatchSize);contextVar.sitesBatchNumber++; }","nodeType":"PROCESS"},"start":{"connectors":[{"exitPortType":"NextStep","nodeId":"upsertCustomerData"}],"name":"start","description":"Start","nodeType":"START"},"getAllCustomerSites":{"filter":"{$customerId}={@customerId} AND {$site.statusId}!='siteDeactivated'","models":["site"],"connectors":[{"exitPortType":"NextStep","nodeId":"areSitesPresent"}],"columns":{"statusId":"IF({$site.id} IS NULL,'','siteDeactivated')","customerId":"site.customerId","id":"site.id"},"name":"getAllCustomerSites","description":"getAllCustomerSites","inputVarMap":{"customBatchSize":"batchSize","customerId":"customerId"},"outputVarMap":{"data":"sitesData","count":"sitesCount","batchNumber":"sitesBatchNumber"},"batchSize":"batchSize","nodeType":"QUERY","getCount":true},"getMoreCustomerSites":{"filter":"{$customerId}={@customerId} AND {$site.statusId}!='siteDeactivated'","models":["site"],"connectors":[{"exitPortType":"NextStep","nodeId":"appendSitesData"}],"columns":{"statusId":"IF({$site.id} IS NULL,'','siteDeactivated')","customerId":"site.customerId","id":"site.id"},"name":"getMoreCustomerSites","description":"getMoreCustomerSites","inputVarMap":{"customBatchSize":"batchSize","customerId":"customerId","sitesBatchNumber":"batchNumber"},"outputVarMap":{"data":"moreSitesData"},"batchSize":"batchSize","nodeType":"QUERY","batchNumber":"batchNumber"},"appendSitesData":{"connectors":[{"exitPortType":"NextStep","nodeId":"areMoreBatchesPresent"}],"contextChangePermitted":true,"name":"appendSitesData","description":"appendSitesData","processRule":"{ if (Array.isArray(contextVar.moreSitesData)) { contextVar.sitesData = contextVar.sitesData.concat(contextVar.moreSitesData); } contextVar.sitesBatchNumber++; }","nodeType":"PROCESS"},"upsertContracts":{"connectors":[{"exitPortType":"NextStep","nodeId":"autoCancelWorkOrderTasks"}],"contextChangePermitted":true,"processId":"customerContractWF","name":"upsertContracts","description":"upsertContracts","inputVarMap":{"customerSubAction":"subAction","customerId":"customerId"},"id":"upsertContracts","nodeType":"WORKFLOW"},"workflowNodes":["start","upsertCustomerData","multiDecision","getAllCustomerSites","areSitesPresent","setCustomerSitesStatusDeactivated","findNumberOfBatches","areMoreBatchesPresent","getMoreCustomerSites","appendSitesData","upsertCustomerSites","upsertContracts","autoCancelWorkOrderTasks","end"],"areSitesPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"setCustomerSitesStatusDeactivated"},{"exitPortType":"FalseStep","nodeId":"upsertContracts"}],"name":"areSitesPresent","description":"areSitesPresent","processRule":"(typeof contextVar.sitesData !== 'undefined' &&  contextVar.sitesData !=='')","nodeType":"DECISION"},"areMoreBatchesPresent":{"connectors":[{"exitPortType":"TrueStep","nodeId":"getMoreCustomerSites"},{"exitPortType":"FalseStep","nodeId":"upsertCustomerSites"}],"name":"areMoreBatchesPresent","description":"areMoreBatchesPresent","processRule":"(contextVar.noOfSitesBatches >= 2 && contextVar.noOfSitesBatches >= contextVar.sitesBatchNumber)","nodeType":"DECISION"},"upsertCustomerData":{"connectors":[{"exitPortType":"NextStep","nodeId":"multiDecision"}],"contextChangePermitted":true,"processId":"customerWF","name":"upsertCustomerData","description":"upsertCustomerData","inputVarMap":{"customerSubAction":"subAction","customer":"customer"},"id":"upsertCustomerData","outputVarMap":{},"nodeType":"WORKFLOW"},"upsertCustomerSites":{"connectors":[{"exitPortType":"NextStep","nodeId":"upsertContracts"}],"contextChangePermitted":true,"processId":"9Y3HVI9FKG","ignoreSubContext":true,"name":"upsertCustomerSites","description":"upsertCustomerSites","inputVarMap":{"cancellationReason":"cancellationReason","customerSubAction":"customerSubAction","siteSubAction":"subAction","sitesData":"site"},"id":"upsertCustomerSites","nodeType":"WORKFLOW"},"workflowContext":{"customBatchSize":1000,"cancellationReason":"@lang.['customerDeactivated','Customer Deactivated']","noOfSitesBatches":0},"multiDecision":{"connectors":[{"condition":"contextVar.customerSubAction==='deactivateCustomer'","exitPortType":"NextStep","nodeId":"getAllCustomerSites"},{"DefaultStep":true,"condition":"contextVar.customerSubAction===''","exitPortType":"NextStep","nodeId":"end"}],"name":"multiDecision","description":"MultiDecision","nodeType":"MULTIDECISION"},"end":{"name":"end","description":"end","nodeType":"END"}}